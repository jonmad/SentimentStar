[{"id":"f529955c.d06708","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"3eea6e24.acc922","type":"kafka-broker","z":"","name":"Mac","hosts":"Jons-MBP-107:9092","selfsign":false,"usetls":false,"cacert":"","clientcert":"","privatekey":"","passphrase":""},{"id":"52449d26.4cf094","type":"twitter-credentials","z":"","screen_name":"jonmaddison"},{"id":"f60d9aa7.b4f7c8","type":"alexa-home-conf","z":"","username":"jonmad"},{"id":"3b34dcc8.15f20c","type":"mqtt-broker","z":"","name":"ESP8266 Connection - Standard Application","broker":"j5lfwx.messaging.internetofthings.ibmcloud.com","port":"1883","clientid":"a:j5lfwx:anyAppId6","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"4ad0b149.6331e8","type":"kafka-consumer","z":"f529955c.d06708","name":"helloworld topic","broker":"3eea6e24.acc922","outOfRangeOffset":"earliest","fromOffset":"latest","topic":"helloworld","groupid":"1","x":540,"y":120,"wires":[["5a9a1863.29c51","20c89090.95b0b"]]},{"id":"803a8142.561418","type":"kafka-producer","z":"f529955c.d06708","name":"nodered topic","broker":"3eea6e24.acc922","topic":"nodered","requireAcks":1,"ackTimeoutMs":100,"attributes":0,"x":820,"y":380,"wires":[]},{"id":"5a9a1863.29c51","type":"debug","z":"f529955c.d06708","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":100,"wires":[]},{"id":"10885a7a.74338e","type":"inject","z":"f529955c.d06708","name":"","topic":"","payload":"hello world","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":120,"wires":[["e30082ea.cc1098","78bdf8ba.e34ad"]]},{"id":"e30082ea.cc1098","type":"debug","z":"f529955c.d06708","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":290,"y":100,"wires":[]},{"id":"20c89090.95b0b","type":"debug","z":"f529955c.d06708","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload.value","targetType":"msg","x":770,"y":140,"wires":[]},{"id":"7bc2297e.666bf8","type":"twitter in","z":"f529955c.d06708","twitter":"52449d26.4cf094","tags":"#brexit, #christmas, #covid","user":"false","name":"#brexit, #christmas, #covid","inputs":0,"x":130,"y":360,"wires":[["bc51e293.a45318","53705b48.486d4c","c757b6d1.2a433"]]},{"id":"2e17679.bcb2a98","type":"debug","z":"f529955c.d06708","name":"tweet classified","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":820,"y":440,"wires":[]},{"id":"252ab44d.b5af5c","type":"switch","z":"f529955c.d06708","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"brexit","vt":"str"},{"t":"cont","v":"Brexit","vt":"str"},{"t":"cont","v":" EU ","vt":"str"},{"t":"cont","v":"christmas","vt":"str"},{"t":"cont","v":"Christmas","vt":"str"},{"t":"cont","v":"Corona","vt":"str"},{"t":"cont","v":"COVID","vt":"str"},{"t":"cont","v":"covid","vt":"str"},{"t":"cont","v":"Covid","vt":"str"},{"t":"cont","v":"vaccine","vt":"str"},{"t":"cont","v":"Vaccine","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":12,"x":230,"y":620,"wires":[["44ea23ad.b66a5c"],["44ea23ad.b66a5c"],["44ea23ad.b66a5c"],["e5b5bb6a.0b8ea8"],["e5b5bb6a.0b8ea8"],["bba7112a.e2ffd8"],["bba7112a.e2ffd8"],["bba7112a.e2ffd8"],["bba7112a.e2ffd8"],["bba7112a.e2ffd8"],["bba7112a.e2ffd8"],["6367a514.18515c"]]},{"id":"e5b5bb6a.0b8ea8","type":"change","z":"f529955c.d06708","name":"christmas","rules":[{"t":"set","p":"payload","pt":"msg","to":"christmas","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":600,"wires":[["e56f7b89.d460d8"]]},{"id":"bba7112a.e2ffd8","type":"change","z":"f529955c.d06708","name":"covid","rules":[{"t":"set","p":"payload","pt":"msg","to":"covid","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":640,"wires":[["e56f7b89.d460d8"]]},{"id":"6367a514.18515c","type":"change","z":"f529955c.d06708","name":"ignored","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":680,"wires":[["83dbf2b2.d745c"]]},{"id":"83dbf2b2.d745c","type":"debug","z":"f529955c.d06708","name":"tweet ignored","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":620,"y":680,"wires":[]},{"id":"44ea23ad.b66a5c","type":"change","z":"f529955c.d06708","name":"brexit","rules":[{"t":"set","p":"payload","pt":"msg","to":"brexit","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":560,"wires":[["e56f7b89.d460d8"]]},{"id":"bc51e293.a45318","type":"debug","z":"f529955c.d06708","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"tweet","targetType":"msg","x":390,"y":360,"wires":[]},{"id":"e56f7b89.d460d8","type":"function","z":"f529955c.d06708","name":"Convert to JSON","func":"msg.payload = {\n        tweettime: Number(msg.tweet.timestamp_ms),\n        tweetclass:msg.payload\n    } ;\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":600,"wires":[["fad26934.06ee7"]]},{"id":"fad26934.06ee7","type":"json","z":"f529955c.d06708","name":"converto to string","property":"payload","action":"","pretty":false,"x":610,"y":440,"wires":[["2e17679.bcb2a98","803a8142.561418"]]},{"id":"37142ce3.9fe54c","type":"kafka-consumer","z":"f529955c.d06708","name":"tweetsperperiod","broker":"3eea6e24.acc922","outOfRangeOffset":"earliest","fromOffset":"latest","topic":"TWEETSPERPERIOD","groupid":"1","x":180,"y":865,"wires":[["b20b30cc.227fb8","141d2b6d.243955"]]},{"id":"b20b30cc.227fb8","type":"debug","z":"f529955c.d06708","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":440,"y":885,"wires":[]},{"id":"f68afdc4.17055","type":"inject","z":"f529955c.d06708","name":"christmas","topic":"","payload":"{\"topic\":\"TWEETSPERPERIOD\",\"value\":\"{\\\"COUNT\\\":12}\",\"offset\":2206,\"partition\":0,\"highWaterOffset\":2210,\"key\":\"christmas\\u0000\\u0000\\u0001vX�\\u0019\\u0000\",\"timestamp\":\"2020-12-12T21:44:09.655Z\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":965,"wires":[["141d2b6d.243955"]]},{"id":"141d2b6d.243955","type":"function","z":"f529955c.d06708","name":"reformat and split out windowId","func":"let windowIdVal = msg.payload.key.substring(msg.payload.key.length-5);\nlet topicVal = msg.payload.key.substring(0,msg.payload.key.length-5);\nlet number = Number(msg.payload.value.split(':')[1].split('}')[0]);\nmsg.payload = {\n        windowId:windowIdVal,\n        topic:topicVal,\n        count:number\n    } ;\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":925,"wires":[["2d852924.868296"]]},{"id":"d9214863.679fd","type":"debug","z":"f529955c.d06708","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":730,"y":1165,"wires":[]},{"id":"bc119d97.5538a8","type":"inject","z":"f529955c.d06708","name":"brexit","topic":"","payload":"{\"topic\":\"TWEETSPERPERIOD\",\"value\":\"{\\\"COUNT\\\":1}\",\"offset\":2210,\"partition\":0,\"highWaterOffset\":2213,\"key\":\"brexit\\u0000\\u0000\\u0001vX�@\\u0010\",\"timestamp\":\"2020-12-12T21:44:12.030Z\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":1045,"wires":[["141d2b6d.243955"]]},{"id":"5cc14e1c.5a4dc8","type":"inject","z":"f529955c.d06708","name":"covid","topic":"","payload":"{\"topic\":\"TWEETSPERPERIOD\",\"value\":\"{\\\"COUNT\\\":3}\",\"offset\":2213,\"partition\":0,\"highWaterOffset\":2215,\"key\":\"covid\\u0000\\u0000\\u0001vX�@\\u0010\",\"timestamp\":\"2020-12-12T21:44:14.265Z\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":1005,"wires":[["141d2b6d.243955"]]},{"id":"2d852924.868296","type":"function","z":"f529955c.d06708","name":"reset high water mark this window","func":"var currentWindowId = global.get(\"currentWindowId\");\nif (currentWindowId)\n{\n    // allow for it not to be set the first time\n    if(currentWindowId==msg.payload.windowId)\n    {\n        // Still in the same window\n        var currentCount = parseInt(global.get(\"currentCount\"));\n        if(msg.payload.count > currentCount)\n        {\n            // This topic (which may be the same topic) has a higher count in this window\n            global.set(\"currentCount\", msg.payload.count);\n            global.set(\"currentTopic\", msg.payload.topic);\n        }\n    }\n    else\n    {\n        // New window - record the last most popular topic\n        global.set(\"newWindow\", \"True\");\n        global.set(\"lastWindowMostPopular\", global.get(\"currentTopic\"));\n        global.set(\"lastWindowCount\", parseInt(global.get(\"currentCount\")));\n        // Reset the high water mark!\n        global.set(\"currentWindowId\", msg.payload.windowId);\n        global.set(\"currentCount\", msg.payload.count);\n        global.set(\"currentTopic\", msg.payload.topic);    \n    }\n}\nelse\n{\n    // Set it the first time\n    global.set(\"currentWindowId\", msg.payload.windowId);\n    global.set(\"currentCount\", msg.payload.count);\n    global.set(\"currentTopic\", msg.payload.topic);\n}\nmsg.payload.currentWindowId=global.get(\"currentWindowId\");\nmsg.payload.currentTopic=global.get(\"currentTopic\");\nmsg.payload.currentCount=parseInt(global.get(\"currentCount\"));\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":985,"wires":[["a4928455.e8fbe8"]]},{"id":"a4928455.e8fbe8","type":"function","z":"f529955c.d06708","name":"set payload to most popular","func":"\nif(global.get(\"newWindow\")==\"True\")\n{\n    msg.payload = {\n        lastWindowMostPopular:global.get(\"lastWindowMostPopular\"),\n        lastWindowCount:parseInt(global.get(\"lastWindowCount\"))\n    };\n    global.set(\"newWindow\", \"False\"); \n}\nelse\n{\n    // Clear the payload\n    msg.payload = null;\n}\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":1045,"wires":[["45309a35.844524"]]},{"id":"45309a35.844524","type":"switch","z":"f529955c.d06708","name":"display if payload not null","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":690,"y":1105,"wires":[["d9214863.679fd"]]},{"id":"f24c326f.005378","type":"http in","z":"f529955c.d06708","name":"lastWindowMostPopular","url":"/lastWindowMostPopular","method":"get","upload":false,"swaggerDoc":"","x":230,"y":1320,"wires":[["46fded74.9586e4"]]},{"id":"eb30209e.7d40d8","type":"http response","z":"f529955c.d06708","name":"","statusCode":"","headers":{},"x":700,"y":1320,"wires":[]},{"id":"46fded74.9586e4","type":"function","z":"f529955c.d06708","name":"set payload to most popular","func":"msg.payload = {\n    lastWindowMostPopular:global.get(\"lastWindowMostPopular\"),\n    lastWindowCount:parseInt(global.get(\"lastWindowCount\"))\n};\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":1320,"wires":[["eb30209e.7d40d8"]]},{"id":"66fb6f7a.cdcb18","type":"debug","z":"f529955c.d06708","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":370,"y":1640,"wires":[]},{"id":"4db7b37e.8fd48c","type":"mqtt in","z":"f529955c.d06708","name":"","topic":"iot-2/type/Pi/id/star/cmd/power/fmt/json","qos":"2","datatype":"auto","broker":"3b34dcc8.15f20c","x":240,"y":1720,"wires":[["ffa0a300.cd5b58"]]},{"id":"ffa0a300.cd5b58","type":"switch","z":"f529955c.d06708","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":550,"y":1720,"wires":[["66fb6f7a.cdcb18","df269fcb.6b5f68"],["66fb6f7a.cdcb18","9862fa0d.57d828"]]},{"id":"df269fcb.6b5f68","type":"function","z":"f529955c.d06708","name":"on","func":"global.set(\"power\", \"on\"); \nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1700,"wires":[[]]},{"id":"9862fa0d.57d828","type":"function","z":"f529955c.d06708","name":"off","func":"global.set(\"power\", \"off\"); \nreturn msg;","outputs":1,"noerr":0,"x":720,"y":1740,"wires":[[]]},{"id":"53705b48.486d4c","type":"switch","z":"f529955c.d06708","name":"route msg if power is on (Alexa controlled)","property":"power","propertyType":"global","rules":[{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":200,"y":440,"wires":[["252ab44d.b5af5c"]]},{"id":"f3b26436.c3c7e8","type":"http in","z":"f529955c.d06708","name":"power","url":"/power","method":"get","upload":false,"swaggerDoc":"","x":190,"y":1480,"wires":[["bbfdbb82.95b33"]]},{"id":"3c441fcc.cc87f","type":"http response","z":"f529955c.d06708","name":"","statusCode":"","headers":{},"x":720,"y":1480,"wires":[]},{"id":"bbfdbb82.95b33","type":"function","z":"f529955c.d06708","name":"set payload to power status","func":"msg.payload = {\n    power:global.get(\"power\"),\n};\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1480,"wires":[["3c441fcc.cc87f"]]},{"id":"c757b6d1.2a433","type":"debug","z":"f529955c.d06708","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":390,"y":400,"wires":[]},{"id":"9103bbd2.6005d8","type":"comment","z":"f529955c.d06708","name":"'Alexa, turn star on/off' commands over MQTT - via Alexa Home Skill Bridge and Node-RED on Watson IoT Platform","info":"","x":450,"y":1598,"wires":[]},{"id":"9993b48d.5e3458","type":"comment","z":"f529955c.d06708","name":"Expose 'power' status (on/off) as an API for Python program to query to turn star on/off","info":"","x":459,"y":1433,"wires":[]},{"id":"2dee7128.bac4de","type":"comment","z":"f529955c.d06708","name":"Expose 'lastWindowMostPopular' tweet class (brexit/christmas/covid) as an API for Python program to query to change star LED pattern","info":"","x":467.8888854980469,"y":1274.5555334091187,"wires":[]},{"id":"b4c9c5c7.243ff","type":"comment","z":"f529955c.d06708","name":"Consumes kafka topic. Tracks the tweet class with the highest count in this window.","info":"","x":410,"y":798,"wires":[]},{"id":"bfad2150.499e6","type":"comment","z":"f529955c.d06708","name":"Test harness consumer of kakfa topic","info":"","x":610,"y":40,"wires":[]},{"id":"c17c8913.373fc","type":"comment","z":"f529955c.d06708","name":"Test harness producer to kakfa topic","info":"","x":200,"y":40,"wires":[]},{"id":"7e545b39.e65d9c","type":"comment","z":"f529955c.d06708","name":"Receives tweets of interest, classifies them and produces them to a kafka topic for aggregation","info":"","x":350,"y":300,"wires":[]},{"id":"13038f4d.04de99","type":"comment","z":"f529955c.d06708","name":"Only process messages when power is 'on'","info":"","x":175,"y":475,"wires":[]},{"id":"3e9403b2.34d144","type":"comment","z":"f529955c.d06708","name":"Sets the 'lastWindowMostPopular' when the window changes.","info":"","x":550,"y":839,"wires":[]},{"id":"78bdf8ba.e34ad","type":"kafka-producer","z":"f529955c.d06708","name":"helloworld topic","broker":"3eea6e24.acc922","topic":"helloworld","requireAcks":1,"ackTimeoutMs":100,"attributes":0,"x":300,"y":140,"wires":[]}]