[{"id":"d0969b4.b807368","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"941d6a09.32d1a","type":"kafka-consumer","z":"d0969b4.b807368","name":"helloworld topic","broker":"","outOfRangeOffset":"earliest","fromOffset":"latest","topic":"helloworld","groupid":"1","x":540,"y":120,"wires":[["c092e1f9.32cb48","6881c1b3.0db26"]]},{"id":"82c7ce7.cd90fb","type":"kafka-producer","z":"d0969b4.b807368","name":"nodered topic","broker":"","topic":"nodered","requireAcks":1,"ackTimeoutMs":100,"attributes":0,"x":820,"y":380,"wires":[]},{"id":"c092e1f9.32cb48","type":"debug","z":"d0969b4.b807368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":100,"wires":[]},{"id":"fbb5a6be.d60f2","type":"inject","z":"d0969b4.b807368","name":"","topic":"","payload":"hello world","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":120,"wires":[["8063129e.e2e408","cd3246a0.3562e8"]]},{"id":"8063129e.e2e408","type":"debug","z":"d0969b4.b807368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":290,"y":100,"wires":[]},{"id":"6881c1b3.0db26","type":"debug","z":"d0969b4.b807368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload.value","targetType":"msg","x":770,"y":140,"wires":[]},{"id":"cc613233.ac45a8","type":"twitter in","z":"d0969b4.b807368","twitter":"","tags":"#brexit, #christmas, #covid","user":"false","name":"#brexit, #christmas, #covid","inputs":0,"x":130,"y":360,"wires":[["952b64e.7859b18","f352e8bf.74e118","75daba83.cfb7b4"]]},{"id":"964893c1.106fb","type":"debug","z":"d0969b4.b807368","name":"tweet classified","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":820,"y":440,"wires":[]},{"id":"36d4460e.b60132","type":"switch","z":"d0969b4.b807368","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"brexit","vt":"str"},{"t":"cont","v":"Brexit","vt":"str"},{"t":"cont","v":" EU ","vt":"str"},{"t":"cont","v":"christmas","vt":"str"},{"t":"cont","v":"Christmas","vt":"str"},{"t":"cont","v":"Corona","vt":"str"},{"t":"cont","v":"COVID","vt":"str"},{"t":"cont","v":"covid","vt":"str"},{"t":"cont","v":"Covid","vt":"str"},{"t":"cont","v":"vaccine","vt":"str"},{"t":"cont","v":"Vaccine","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":12,"x":230,"y":620,"wires":[["8f0bc522.26bda8"],["8f0bc522.26bda8"],["8f0bc522.26bda8"],["7e3f65f6.4a9f1c"],["7e3f65f6.4a9f1c"],["5940abd7.7a95e4"],["5940abd7.7a95e4"],["5940abd7.7a95e4"],["5940abd7.7a95e4"],["5940abd7.7a95e4"],["5940abd7.7a95e4"],["d7e9488f.ddf798"]]},{"id":"7e3f65f6.4a9f1c","type":"change","z":"d0969b4.b807368","name":"christmas","rules":[{"t":"set","p":"payload","pt":"msg","to":"christmas","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":600,"wires":[["95efec1.d3bec9"]]},{"id":"5940abd7.7a95e4","type":"change","z":"d0969b4.b807368","name":"covid","rules":[{"t":"set","p":"payload","pt":"msg","to":"covid","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":640,"wires":[["95efec1.d3bec9"]]},{"id":"d7e9488f.ddf798","type":"change","z":"d0969b4.b807368","name":"ignored","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":680,"wires":[["14be3e4f.dfaac2"]]},{"id":"14be3e4f.dfaac2","type":"debug","z":"d0969b4.b807368","name":"tweet ignored","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":620,"y":680,"wires":[]},{"id":"8f0bc522.26bda8","type":"change","z":"d0969b4.b807368","name":"brexit","rules":[{"t":"set","p":"payload","pt":"msg","to":"brexit","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":560,"wires":[["95efec1.d3bec9"]]},{"id":"952b64e.7859b18","type":"debug","z":"d0969b4.b807368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"tweet","targetType":"msg","x":390,"y":360,"wires":[]},{"id":"95efec1.d3bec9","type":"function","z":"d0969b4.b807368","name":"Convert to JSON","func":"msg.payload = {\n        tweettime: Number(msg.tweet.timestamp_ms),\n        tweetclass:msg.payload\n    } ;\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":600,"wires":[["79c203a0.50246c"]]},{"id":"79c203a0.50246c","type":"json","z":"d0969b4.b807368","name":"converto to string","property":"payload","action":"","pretty":false,"x":610,"y":440,"wires":[["964893c1.106fb","82c7ce7.cd90fb"]]},{"id":"47412607.0ad328","type":"kafka-consumer","z":"d0969b4.b807368","name":"tweetsperperiod","broker":"","outOfRangeOffset":"earliest","fromOffset":"latest","topic":"TWEETSPERPERIOD","groupid":"1","x":180,"y":865,"wires":[["9d22b7c7.6d95","535b66c6.155df"]]},{"id":"9d22b7c7.6d95","type":"debug","z":"d0969b4.b807368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":440,"y":885,"wires":[]},{"id":"5301db38.73ecf4","type":"inject","z":"d0969b4.b807368","name":"christmas","topic":"","payload":"{\"topic\":\"TWEETSPERPERIOD\",\"value\":\"{\\\"COUNT\\\":12}\",\"offset\":2206,\"partition\":0,\"highWaterOffset\":2210,\"key\":\"christmas\\u0000\\u0000\\u0001vX�\\u0019\\u0000\",\"timestamp\":\"2020-12-12T21:44:09.655Z\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":965,"wires":[["535b66c6.155df"]]},{"id":"535b66c6.155df","type":"function","z":"d0969b4.b807368","name":"reformat and split out windowId","func":"let windowIdVal = msg.payload.key.substring(msg.payload.key.length-5);\nlet topicVal = msg.payload.key.substring(0,msg.payload.key.length-5);\nlet number = Number(msg.payload.value.split(':')[1].split('}')[0]);\nmsg.payload = {\n        windowId:windowIdVal,\n        topic:topicVal,\n        count:number\n    } ;\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":925,"wires":[["8861dc.25ed5628"]]},{"id":"4442a2ec.2ac08c","type":"debug","z":"d0969b4.b807368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":730,"y":1165,"wires":[]},{"id":"7982b993.5fed68","type":"inject","z":"d0969b4.b807368","name":"brexit","topic":"","payload":"{\"topic\":\"TWEETSPERPERIOD\",\"value\":\"{\\\"COUNT\\\":1}\",\"offset\":2210,\"partition\":0,\"highWaterOffset\":2213,\"key\":\"brexit\\u0000\\u0000\\u0001vX�@\\u0010\",\"timestamp\":\"2020-12-12T21:44:12.030Z\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":1045,"wires":[["535b66c6.155df"]]},{"id":"c27bfcfd.1d2a","type":"inject","z":"d0969b4.b807368","name":"covid","topic":"","payload":"{\"topic\":\"TWEETSPERPERIOD\",\"value\":\"{\\\"COUNT\\\":3}\",\"offset\":2213,\"partition\":0,\"highWaterOffset\":2215,\"key\":\"covid\\u0000\\u0000\\u0001vX�@\\u0010\",\"timestamp\":\"2020-12-12T21:44:14.265Z\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":1005,"wires":[["535b66c6.155df"]]},{"id":"8861dc.25ed5628","type":"function","z":"d0969b4.b807368","name":"reset high water mark this window","func":"var currentWindowId = global.get(\"currentWindowId\");\nif (currentWindowId)\n{\n    // allow for it not to be set the first time\n    if(currentWindowId==msg.payload.windowId)\n    {\n        // Still in the same window\n        var currentCount = parseInt(global.get(\"currentCount\"));\n        if(msg.payload.count > currentCount)\n        {\n            // This topic (which may be the same topic) has a higher count in this window\n            global.set(\"currentCount\", msg.payload.count);\n            global.set(\"currentTopic\", msg.payload.topic);\n        }\n    }\n    else\n    {\n        // New window - record the last most popular topic\n        global.set(\"newWindow\", \"True\");\n        global.set(\"lastWindowMostPopular\", global.get(\"currentTopic\"));\n        global.set(\"lastWindowCount\", parseInt(global.get(\"currentCount\")));\n        // Reset the high water mark!\n        global.set(\"currentWindowId\", msg.payload.windowId);\n        global.set(\"currentCount\", msg.payload.count);\n        global.set(\"currentTopic\", msg.payload.topic);    \n    }\n}\nelse\n{\n    // Set it the first time\n    global.set(\"currentWindowId\", msg.payload.windowId);\n    global.set(\"currentCount\", msg.payload.count);\n    global.set(\"currentTopic\", msg.payload.topic);\n}\nmsg.payload.currentWindowId=global.get(\"currentWindowId\");\nmsg.payload.currentTopic=global.get(\"currentTopic\");\nmsg.payload.currentCount=parseInt(global.get(\"currentCount\"));\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":985,"wires":[["298cf6b9.a668ea"]]},{"id":"298cf6b9.a668ea","type":"function","z":"d0969b4.b807368","name":"set payload to most popular","func":"\nif(global.get(\"newWindow\")==\"True\")\n{\n    msg.payload = {\n        lastWindowMostPopular:global.get(\"lastWindowMostPopular\"),\n        lastWindowCount:parseInt(global.get(\"lastWindowCount\"))\n    };\n    global.set(\"newWindow\", \"False\"); \n}\nelse\n{\n    // Clear the payload\n    msg.payload = null;\n}\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":1045,"wires":[["bc294065.0719f"]]},{"id":"bc294065.0719f","type":"switch","z":"d0969b4.b807368","name":"display if payload not null","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":690,"y":1105,"wires":[["4442a2ec.2ac08c"]]},{"id":"76d8ce23.d251b","type":"http in","z":"d0969b4.b807368","name":"lastWindowMostPopular","url":"/lastWindowMostPopular","method":"get","upload":false,"swaggerDoc":"","x":230,"y":1320,"wires":[["a4626fa3.020768"]]},{"id":"7a3c711.7d73a1","type":"http response","z":"d0969b4.b807368","name":"","statusCode":"","headers":{},"x":700,"y":1320,"wires":[]},{"id":"a4626fa3.020768","type":"function","z":"d0969b4.b807368","name":"set payload to most popular","func":"msg.payload = {\n    lastWindowMostPopular:global.get(\"lastWindowMostPopular\"),\n    lastWindowCount:parseInt(global.get(\"lastWindowCount\"))\n};\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":1320,"wires":[["7a3c711.7d73a1"]]},{"id":"22073ca4.a4bb84","type":"debug","z":"d0969b4.b807368","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":370,"y":1640,"wires":[]},{"id":"f1b4f27e.42f5e8","type":"switch","z":"d0969b4.b807368","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":550,"y":1720,"wires":[["22073ca4.a4bb84","51870a43.87641c"],["22073ca4.a4bb84","2614cfd5.b9fa18"]]},{"id":"51870a43.87641c","type":"function","z":"d0969b4.b807368","name":"on","func":"global.set(\"power\", \"on\"); \nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1700,"wires":[[]]},{"id":"2614cfd5.b9fa18","type":"function","z":"d0969b4.b807368","name":"off","func":"global.set(\"power\", \"off\"); \nreturn msg;","outputs":1,"noerr":0,"x":720,"y":1740,"wires":[[]]},{"id":"f352e8bf.74e118","type":"switch","z":"d0969b4.b807368","name":"route msg if power is on (Alexa controlled)","property":"power","propertyType":"global","rules":[{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":200,"y":440,"wires":[["36d4460e.b60132"]]},{"id":"edbaef55.d263c8","type":"http in","z":"d0969b4.b807368","name":"power","url":"/power","method":"get","upload":false,"swaggerDoc":"","x":190,"y":1480,"wires":[["7f1b39cc.3ee0c"]]},{"id":"72f7406.3ec58c","type":"http response","z":"d0969b4.b807368","name":"","statusCode":"","headers":{},"x":720,"y":1480,"wires":[]},{"id":"7f1b39cc.3ee0c","type":"function","z":"d0969b4.b807368","name":"set payload to power status","func":"msg.payload = {\n    power:global.get(\"power\"),\n};\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1480,"wires":[["72f7406.3ec58c"]]},{"id":"75daba83.cfb7b4","type":"debug","z":"d0969b4.b807368","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":390,"y":400,"wires":[]},{"id":"2436a763.c7107","type":"comment","z":"d0969b4.b807368","name":"Turn star on/off' - local test harness here. Could use commands over MQTT e.g. for Alexa-control using Alexa Home Skill Bridge","info":"","x":470,"y":1600,"wires":[]},{"id":"6bee1cc0.85c2cc","type":"comment","z":"d0969b4.b807368","name":"Expose 'power' status (on/off) as an API for Python program to query to turn star on/off","info":"","x":459,"y":1433,"wires":[]},{"id":"736734c7.7ea374","type":"comment","z":"d0969b4.b807368","name":"Expose 'lastWindowMostPopular' tweet class (brexit/christmas/covid) as an API for Python program to query to change star LED pattern","info":"","x":467.8888854980469,"y":1274.5555334091187,"wires":[]},{"id":"a832dbdd.7f874","type":"comment","z":"d0969b4.b807368","name":"Consumes kafka topic. Tracks the tweet class with the highest count in this window.","info":"","x":410,"y":798,"wires":[]},{"id":"d7e9832c.57e02","type":"comment","z":"d0969b4.b807368","name":"Test harness consumer of kakfa topic","info":"","x":610,"y":40,"wires":[]},{"id":"40052206.0f2394","type":"comment","z":"d0969b4.b807368","name":"Test harness producer to kakfa topic","info":"","x":200,"y":40,"wires":[]},{"id":"ff48addf.cc0d5","type":"comment","z":"d0969b4.b807368","name":"Receives tweets of interest, classifies them and produces them to a kafka topic for aggregation","info":"","x":350,"y":300,"wires":[]},{"id":"96b20900.8e81b8","type":"comment","z":"d0969b4.b807368","name":"Only process messages when power is 'on'","info":"","x":175,"y":475,"wires":[]},{"id":"88fc77f0.bd0a28","type":"comment","z":"d0969b4.b807368","name":"Sets the 'lastWindowMostPopular' when the window changes.","info":"","x":550,"y":839,"wires":[]},{"id":"cd3246a0.3562e8","type":"kafka-producer","z":"d0969b4.b807368","name":"helloworld topic","broker":"","topic":"helloworld","requireAcks":1,"ackTimeoutMs":100,"attributes":0,"x":300,"y":140,"wires":[]},{"id":"9c0400ba.6fa32","type":"inject","z":"d0969b4.b807368","name":"Power on","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1720,"wires":[["f1b4f27e.42f5e8"]]},{"id":"813878dc.e97908","type":"inject","z":"d0969b4.b807368","name":"Power off","topic":"","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1760,"wires":[["f1b4f27e.42f5e8"]]}]